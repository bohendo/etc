#!/bin/bash

year_prefix="20"

fail="❌"
good="✅"
warn="⚠️ "

media=$HOME/Media
if [[ ! -d "$media" ]]
then mkdir -p "$media"
fi

if [[ -z "$(command -v exiftool)" ]]
then echo "$fail Install exiftool first" && exit 1
fi

target="$1"
if [[ ! -f "$target" ]]
then echo "$fail File does not exist at $target" && exit 1
fi

ext=$(exiftool -FileTypeExtension "$target" 2> /dev/null | sed 's/^.*: //')
if [[ \
  "$ext" != "avi" &&\
  "$ext" != "gif" &&\
  "$ext" != "jpg" &&\
  "$ext" != "mov" &&\
  "$ext" != "mp4" &&\
  "$ext" != "png" \
  ]]
then echo "$fail Unknown FileTypeExtension $ext for $target" && exit 1
fi

created=$(exiftool -CreateDate "$target" 2> /dev/null | sed 's/.*  ://' | sed 's/: /:0/g' | sed 's/://g' | sed 's/ /-/g' | sed 's/-$//' | sed 's/^-//' | sed 's/^'"$year_prefix"'//')
if [[ -z "$created" ]]
then
  echo "$warn No available CreateDate exif data for $target"
  created="000000-000000" # TODO: check to see if the filename includes a date?
  year_prefix="00"
fi

full_digest=$(sha256sum "$target" | cut -d " " -f 1)
digest=$(echo "$full_digest" | head -c 8)

name="$media/$year_prefix${created::2}/$created-$digest.$ext"

if [[ -f "$name" ]]
then
  dup_digest=$(sha256sum "$name" | cut -d " " -f 1)
  if [[ "$dup_digest" == "$full_digest" ]]
  then echo "$good Destination $name already exists w the same digest as our target"
  else echo "$fail Destination $name already exists w DIFFERENT digest than $target"
  fi
  exit 0
fi

# Check for other files in media w the same digest
if ! dups=$(find "$media/" -type "f" -name "*-$digest.*")
then echo "$fail Failed to search for files with digest of $digest" && exit 1
fi
if [[ -n "$dups" ]]
then
  for dup in $dups
  do
    dup_digest=$(sha256sum "$dup" | cut -d " " -f 1)
    if [[ "$dup_digest" == "$full_digest" ]]
    then echo "$good $dup & target have same digest: $dup_digest"
    else echo "$warn $dups ($dup_digest) & target ($full_digest) have similar digests"
    fi
  done
  exit 1
fi

if [[ "$2" == "-n" ]]
then echo "$good Copying $target to $name"
elif [[ "$2" == "-y" ]]
then
  if [[ ! -d "$(dirname "$name")" ]]
  then mkdir -vp "$(dirname "$name")"
  fi
  cp -vi "$target" "$name"
else
  echo "Use the 2nd arg to specify whether or not you actually want to make changes"
  echo "  -n  No I don't want to make changes, show me what the changes would be"
  echo "  -y  Yes I want to make changes"
fi
