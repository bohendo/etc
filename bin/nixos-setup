#! /usr/bin/env bash
set -e

# Get path to this etc project dir
etc="$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." >/dev/null 2>&1 && pwd )"

cd "$etc" || exit 1

if [[ -n "$(git status -s)" ]]
then echo "Git repo is dirty" && exit
else echo "rebuilding system from $etc"
fi

nix run --impure github:nix-community/home-manager -- switch --flake "$etc"
echo; echo "Switching to new nixos build.."; echo
sudo nixos-rebuild switch --flake "$etc" -L # what does -L do?
home-manager switch --flake "$etc"
