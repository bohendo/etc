#! /usr/bin/env bash
set -e

########################################
# Check/fix environment

# Get path to this etc project dir
etc="$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." >/dev/null 2>&1 && pwd )"

cd "$etc" || exit 1

if [[ -n "$(git status -s)" ]]
then echo "Git repo is dirty" && exit
else echo "rebuilding system from $etc"
fi

if ! nix flake check --impure github:nix-community/home-manager
then
  echo "Enabling experimental nix features.."
  mkdir -p ~/.config/nix
  echo 'experimental-features = nix-command flakes' > ~/.config/nix/nix.conf
  if ! nix flake check
  then echo "Success"
  else echo "Failure, the flake.nix might have a syntax error" && exit 1
  fi
fi

########################################
# Pure build & installation

nix run --impure github:nix-community/home-manager -- switch --flake "$etc/nixos"
echo; echo "Switching to new nixos build.."; echo
sudo nixos-rebuild switch --flake "$etc/nixos" -L # what does -L do?
home-manager switch --flake "$etc/nixos"

########################################
# Impure post install steps

if [[ "$(gsettings get org.gnome.desktop.input-sources xkb-options)" == "@as []" ]]
then
  echo "Capslock remap not registerd, refreshing gnome desktop input setting.."
  # Impure: need to run this once on the fresh OS to get xkbOptions to load
  gsettings reset org.gnome.desktop.input-sources xkb-options
  gsettings reset org.gnome.desktop.input-sources sources
  echo "gsettings reset, you might need to log out and back in for them to be properly applied"
else
  echo "keyboard remappings looks good"
fi

# if [[ "$(dropbox status)" == "Dropbox isn't running!" ]]
# then dropbox autostart y && dropbox start 2> /dev/null
# fi

docker swarm init 2> /dev/null # idc about "alreaded initalized" errors on subsequent inits
