#!/bin/bash
set -e

target="${1%/}"
dryrun="$2"

if [[ "$dryrun" != "-n" && "$dryrun" != "-y" ]]
then
  echo "Use the 2nd arg to specify whether or not you actually want to make changes"
  echo "  -n  No I don't want to make changes, show me what the changes would be"
  echo "  -y  Yes I want to make changes, show me what changes I'm making"
  exit
fi

function getStdName {
  bytes="$(stat "$1" | grep -E -o 'Size: [0-9]+' | sed 's/Size: //')"
  len="$(( ${#bytes} - 3 ))"
  if [[ "$len" -gt "0" ]]
  then kbytes="$(printf "%08d" "${bytes::$len}")"
  else kbytes="00000000"
  fi
  digest="$(sha256sum "$1" | head -c8)"
  ext="$(echo "${1##*.}" | tr '[:upper:]' '[:lower:]')"
  dir=$(dirname "$1")
  echo "$dir/$kbytes-$digest.$ext"
}

if [[ -f "$target" ]]
then
  stdName="$(getStdName "$target")"
  if [[ "$2" == "-y" ]]
  then mv -fv "$target" "$stdName"
  else echo mv -fv "$target" "$stdName"
  fi
else
  # Rename all imports to a standard name
  while IFS= read -r -d '' pic
  do
    stdName="$(getStdName "$pic")"
    # Is this picture already well formatted?
    if [[ ! "$pic" = "$stdName" ]]
    then
      if [[ "$2" == "-y" ]]
      then mv -fv "$pic" "$stdName"
      else echo "mv -fv $pic $stdName"
      fi
    fi
  done < <(find "$target" -print0 -type f)
fi
